from langchain_core.messages import BaseMessage, HumanMessage, ToolMessage, AIMessage
from typing import TypedDict, Annotated, Any, Dict
from langchain_core.documents import Document
from pprint import pprint


result = {'messages': [HumanMessage(content='If I have Plan N, how much do I pay for an emergency room visit if I am admitted to the hospital', additional_kwargs={}, response_metadata={}, id='c834d1a0-f0e2-4f0b-b27a-247c9c55cb3f'), AIMessage(content='', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 23, 'prompt_tokens': 157, 'total_tokens': 180, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-3.5-turbo-0125', 'system_fingerprint': None, 'id': 'chatcmpl-D47HKGvn4FEzkATFmJV6823EOsm8U', 'service_tier': 'default', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--019c14b0-e4a7-7423-9d8f-77b74b1dbdeb-0', tool_calls=[{'name': 'retrieve_context', 'args': {'query': 'Plan N emergency room visit cost when admitted to hospital'}, 'id': 'call_qFhqZM11xicJcYrb5f0CyCCY', 'type': 'tool_call'}], invalid_tool_calls=[], usage_metadata={'input_tokens': 157, 'output_tokens': 23, 'total_tokens': 180, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}), ToolMessage(content='Source: ind-medsup-metro-std-uw-ooc-eff-apr-il-2024.pdf\n\nContent: to any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nUp to $20 per office \nvisit and up to $50 per \nemergency room visit. \nThe copayment of up \nto $50 is waived if the \ninsured is admitted \nto any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nPart B Excess Charges \n(above Medicare-approved amounts) $0 $0 All costs \nBlood \nFirst 3 pints $0 All costs $0 \nNext $257 of Medicare-approved \namounts\u200a7 $0 $0 $257 (Part B \ndeductible)\n\nSource: ind-medsup-metro-std-uw-ooc-eff-apr-il-2024.pdf\n\nContent: to any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nUp to $20 per office \nvisit and up to $50 per \nemergency room visit. \nThe copayment of up \nto $50 is waived if the \ninsured is admitted \nto any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nPart B Excess Charges \n(above Medicare-approved amounts) $0 $0 All costs \nBlood \nFirst 3 pints $0 All costs $0 \nNext $257 of Medicare-approved \namounts\u200a7 $0 $0 $257 (Part B \ndeductible)\n\nSource: Jan2026-MedSupp-SOB-EN.pdf\n\nContent: insured is \nadmitted to any \nhospital and the \nemergency visit \nis covered as a \nMedicare Part A \nexpense. \nUp to $20 per \noffice visit and \nup to $50 per \nemergency \nroom visit. The \ncopayment of \nup to $50 is \nwaived if the \ninsured is \nadmitted to \nany hospital \nand the \nemergency \nvisit is covered \nas a \nMedicare Part \nA expense. \nPart B excess charges (above \nMedicare-approved amounts) \n$0 $0 All costs \nBLOOD \nFirst 3 Pints (Part B) $0 All costs $0 \nNext $257 of Medicare-approved\n\nSource: 202601MEDSUPPLANN.pdf\n\nContent: insured is \nadmitted to any \nhospital and the \nemergency visit \nis covered as a \nMedicare Part A \nexpense. \nUp to $20 per \noffice visit and \nup to $50 per \nemergency \nroom visit. The \ncopayment of \nup to $50 is \nwaived if the \ninsured is \nadmitted to \nany hospital \nand the \nemergency \nvisit is covered \nas a \nMedicare Part \nA expense. \nPart B excess charges (above \nMedicare-approved amounts) \n$0 $0 All costs \nBLOOD \nFirst 3 Pints (Part B) $0 All costs $0 \nNext $257 of Medicare-approved', name='retrieve_context', id='70ecaa84-dc76-48bb-9348-70c7bc76cd52', tool_call_id='call_qFhqZM11xicJcYrb5f0CyCCY', artifact=[Document(id='b7d9a76c-abed-4da5-8d93-5f5d10b0b2af', metadata={'MY_page_number': 37.0, 'author': 'Blue Cross Blue Shield of Illinois.', 'creationdate': '2024-12-03T16:37:57-06:00', 'creator': 'Adobe InDesign 19.4 (Macintosh)', 'moddate': '2024-12-12T12:21:52-06:00', 'nccl_app': 'PDF', 'nccl_standard': 'HHS (2018 Regulations);', 'nccl_status': 'Passed', 'page': 36.0, 'page_label': '37', 'producer': 'Adobe PDF Library 17.0', 'source': 'ind-medsup-metro-std-uw-ooc-eff-apr-il-2024.pdf', 'subject': 'Outline of Medicare Supplement Coverage — Standard Benefits for Plans A, F, F Plus, N, and N Plus; Standard and Medicare Select Benefits4 for Plan G and Plan G Plus', 'title': 'Outline of Medicare Supplement Coverage — Standard Benefits for Plans A, F, F Plus, N, and N Plus; Standard and Medicare Select Benefits4 for Plan G and Plan G Plus', 'total_pages': 43.0, 'trapped': '/False'}, page_content='to any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nUp to $20 per office \nvisit and up to $50 per \nemergency room visit. \nThe copayment of up \nto $50 is waived if the \ninsured is admitted \nto any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nPart B Excess Charges \n(above Medicare-approved amounts) $0 $0 All costs \nBlood \nFirst 3 pints $0 All costs $0 \nNext $257 of Medicare-approved \namounts\u200a7 $0 $0 $257 (Part B \ndeductible)'), Document(id='c7e8ecac-da63-4b2a-821f-4a94ca3522dc', metadata={'MY_page_number': 40.0, 'author': 'Blue Cross Blue Shield of Illinois.', 'creationdate': '2024-12-03T16:37:57-06:00', 'creator': 'Adobe InDesign 19.4 (Macintosh)', 'moddate': '2024-12-12T12:21:52-06:00', 'nccl_app': 'PDF', 'nccl_standard': 'HHS (2018 Regulations);', 'nccl_status': 'Passed', 'page': 39.0, 'page_label': '40', 'producer': 'Adobe PDF Library 17.0', 'source': 'ind-medsup-metro-std-uw-ooc-eff-apr-il-2024.pdf', 'subject': 'Outline of Medicare Supplement Coverage — Standard Benefits for Plans A, F, F Plus, N, and N Plus; Standard and Medicare Select Benefits4 for Plan G and Plan G Plus', 'title': 'Outline of Medicare Supplement Coverage — Standard Benefits for Plans A, F, F Plus, N, and N Plus; Standard and Medicare Select Benefits4 for Plan G and Plan G Plus', 'total_pages': 43.0, 'trapped': '/False'}, page_content='to any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nUp to $20 per office \nvisit and up to $50 per \nemergency room visit. \nThe copayment of up \nto $50 is waived if the \ninsured is admitted \nto any hospital and \nthe emergency visit is \ncovered as a Medicare \nPart A expense. \nPart B Excess Charges \n(above Medicare-approved amounts) $0 $0 All costs \nBlood \nFirst 3 pints $0 All costs $0 \nNext $257 of Medicare-approved \namounts\u200a7 $0 $0 $257 (Part B \ndeductible)'), Document(id='8900d359-1801-48bb-8c63-87e7e69bdee6', metadata={'MY_page_number': 28.0, '_dlc_dociditemguid': '21cea15d-150c-4378-988b-fe2d5a7eb12b', 'author': 'Blue Shield of California', 'company': '', 'contenttypeid': '0x010100352689E04BD3AE45BBEBB9FF3817DBA7', 'creationdate': '2025-09-30T10:51:52-07:00', 'creator': 'Acrobat PDFMaker 23 for Word', 'keywords': 'Blue Shield Medicare Supplement plans Summary of benefits and provisions', 'moddate': '2025-10-01T11:43:19-05:00', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_actionid': '3be5db9a-5fbb-4bd2-9250-885396b44dd9', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_contentbits': '0', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_enabled': 'true', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_method': 'Standard', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_name': 'Company Internal Use', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_setdate': '2025-09-05T21:02:13Z', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_siteid': '1ccc79e9-1dda-45b4-8335-a298cbe52241', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_tag': '10, 3, 0, 1', 'page': 27.0, 'page_label': '28', 'producer': 'Adobe PDF Library 23.8.53', 'source': 'Jan2026-MedSupp-SOB-EN.pdf', 'sourcemodified': 'D:20250930174734', 'subject': 'Blue Shield Medicare Supplement plans Summary of benefits and provisions', 'title': 'Blue Shield Medicare Supplement plans Summary of benefits and provisions', 'total_pages': 38.0}, page_content='insured is \nadmitted to any \nhospital and the \nemergency visit \nis covered as a \nMedicare Part A \nexpense. \nUp to $20 per \noffice visit and \nup to $50 per \nemergency \nroom visit. The \ncopayment of \nup to $50 is \nwaived if the \ninsured is \nadmitted to \nany hospital \nand the \nemergency \nvisit is covered \nas a \nMedicare Part \nA expense. \nPart B excess charges (above \nMedicare-approved amounts) \n$0 $0 All costs \nBLOOD \nFirst 3 Pints (Part B) $0 All costs $0 \nNext $257 of Medicare-approved'), Document(id='1e302328-84da-43df-aec4-ea4216dffc0e', metadata={'MY_page_number': 8.0, 'author': 'Litten, Angelique', 'company': 'BSC', 'creationdate': '2025-10-01T17:50:43-07:00', 'creator': 'Acrobat PDFMaker 25 for Word', 'moddate': '2025-10-01T17:50:56-07:00', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_actionid': '66f7305e-18c0-4043-9d40-3d5db8fabc6d', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_contentbits': '0', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_enabled': 'true', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_method': 'Standard', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_name': 'Company Internal Use', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_setdate': '2025-09-04T22:13:10Z', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_siteid': '1ccc79e9-1dda-45b4-8335-a298cbe52241', 'msip_label_cce6c6c3-7989-4dfe-877e-1e5d29353dd0_tag': '10, 3, 0, 1', 'page': 7.0, 'page_label': '8', 'producer': 'Adobe PDF Library 25.1.213', 'source': '202601MEDSUPPLANN.pdf', 'sourcemodified': 'D:20251002003042', 'total_pages': 29.0}, page_content='insured is \nadmitted to any \nhospital and the \nemergency visit \nis covered as a \nMedicare Part A \nexpense. \nUp to $20 per \noffice visit and \nup to $50 per \nemergency \nroom visit. The \ncopayment of \nup to $50 is \nwaived if the \ninsured is \nadmitted to \nany hospital \nand the \nemergency \nvisit is covered \nas a \nMedicare Part \nA expense. \nPart B excess charges (above \nMedicare-approved amounts) \n$0 $0 All costs \nBLOOD \nFirst 3 Pints (Part B) $0 All costs $0 \nNext $257 of Medicare-approved')]), AIMessage(content='If you have Plan N and are admitted to the hospital after an emergency room visit, you would pay up to $50 for the emergency room visit. However, the copayment of up to $50 is waived if the emergency visit is covered as a Medicare Part A expense and you are admitted to any hospital (Source: ind-medsup-metro-std-uw-ooc-eff-apr-il-2024.pdf, Page 7).', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 90, 'prompt_tokens': 829, 'total_tokens': 919, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-3.5-turbo-0125', 'system_fingerprint': None, 'id': 'chatcmpl-D47HNqX8NgccMnefTI98vxO9sANvs', 'service_tier': 'default', 'finish_reason': 'stop', 'logprobs': None}, id='lc_run--019c14b0-ee47-72a3-9e03-ae09c0ab6c71-0', tool_calls=[], invalid_tool_calls=[], usage_metadata={'input_tokens': 829, 'output_tokens': 90, 'total_tokens': 919, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}

def has_tool_message(result):
    # Case 1: result is a single message
    if hasattr(result, "tool_calls") and result.tool_calls:
        return True

    # Case 2: result is a dict with messages
    if isinstance(result, dict) and "messages" in result:
        for msg in result["messages"]:
            if getattr(msg, "type", None) == "tool":
                return True
            if hasattr(msg, "tool_calls") and msg.tool_calls:
                return True
    return False

LAST=-1
def extract_ans_metadata(result: Dict[str, Any]) -> Dict[str, Any]:
    audit = [] #{"Source": "abcd.pdf", "Page_Num": 2}
    if has_tool_message(result):
        print("*************** A tool Message is present   **********************")
        answer = result["messages"][LAST].content
        print(answer)
        tool_msg = next(msg for msg in result["messages"] if isinstance(msg, ToolMessage))
        print(tool_msg)
        for artifact in tool_msg.artifact:
            print(artifact.metadata["source"])
            print(artifact.metadata["MY_page_number"])
            audit.append({
                "source": artifact.metadata["source"],
                "sage_number": artifact.metadata["MY_page_number"]
            })
    return {
        "answer": answer,
        "audit": audit
    }


if __name__ == "__main__":
    final_answer = extract_ans_metadata(result)
    pprint(final_answer)